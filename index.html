<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>YouTube to OPML</title>
    <script src="code.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="http://scripting.com/code/opmlpackage/client/opml.js"></script>
  </head>

  <body>
    <form id="form" name="uploadForm">
      <div>
        <input id="csvFile" type="file"/>
      </div>
      <div><input type="submit" value="Send file" /></div>
      <button onclick=downloadOPML(result.value,'youtube_feeds.opml')>Download</button>
      <div>
        <textarea style="white-space: pre; tab-size: 3" id="result" spellcheck="false" cols=150 rows=50 readonly>Carregue um CSV e clique em "Enviar"</textarea>
      </div>
    </form>

    <script>
      const csvFile = document.getElementById('csvFile')
      const form = document.getElementById('form')
      const result = document.getElementById('result')

      form.addEventListener('submit', async function (e) {
        const opmlObj = {
          opml: {
            head: {
              title: 'YouTube Feeds',
              docs: 'http://opml.org/spec2.opml',
              dateCreated: (new Date()).toUTCString()
            },
            body: {
              subs: [
                {
                  text: 'YouTube Feeds',
                  subs: []
                }
              ]
            }
          }
        }

        e.preventDefault()
        const text = await csvFile.files[0].text()
        const parsedCsv = d3.csvParse(text)

        for (const channel of parsedCsv) {
          if (channel["Channel ID"] === '') break

          opmlObj.opml.body.subs[0].subs.push({
            type: "rss",
            text: channel["Channel title"],
            title: channel["Channel title"],
            xmlUrl: `https://www.youtube.com/feeds/videos.xml?channel_id=${channel["Channel ID"]}`,
            htmlUrl: channel["Channel URL"],
            version: 'RSS2'
          })
        }
        /*
        Não é bonito forçar a codificação, mas o CSV do Google vem em UTF-8.
        O próprio autor do opmlPackage admite esse uso em algumas situações.
        Não encontrei nada no padrão que forçasse uma codificação específica.
        
        Ver https://github.com/scripting/opmlPackage/issues/6
        */
        result.value = opml.stringify(opmlObj).replace("ISO-8859-1", "UTF-8")
      })
    </script>
  </body>
</html>

